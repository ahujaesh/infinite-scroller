<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="TikTok Style Infinite Scroller">
    <meta name="keywords" content="TikTok, infinite scroller, web development">
    <meta name="author" content="Eshaan Ahuja">
    <link rel="icon" href="favicon.png" type="image/x-icon">
    <link rel="stylesheet" href="cssMIN.css">
    
    <title>FTC Infinite Scroller</title>

    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
      }

      .sentinel {
        height: 20px;
        background-color: transparent;
      }

      .item {
        border: 1px solid #ccc;
        padding: 20px;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <div id="header">
      <h1>This Website is a TikTok style infinite scroller, that will load infinitely many FTC team names.</h1>
      <p> Credit to <a href="https://ftcscout.org/api">https://ftcscout.org/api</a> for the team names.</p>
    </div>
    <div id="content">
      <div class="sentinel"></div>
    </div>

    <script>
      const content = document.getElementById("content");
      const sentinel = document.querySelector(".sentinel");
      const options = {
        root: null,
        rootMargin: "0px",
        threshold: 0.4, // Trigger when the sentinel is 80% visible
      };

      // Set to store unique team names
      const uniqueTeamNames = new Set();
      const triedNum = new Set();

      function handleIntersection(entries, observer) {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            setTimeout(() => {
              loadMoreItems();
            }, 500); // mimic async call
          }
        });
      }

      function addElements(min, max) {
        for (let i = min; i <= max; i++) {
          const newItem = document.createElement("div");
          newItem.classList.add("item");
          lookupTeamName(i, newItem, min, max);
          triedNum.add(i);
          content.appendChild(newItem);
        }
      }

      function loadMoreItems() {
        const len = content.children.length;
        const newMin = len + 1;
        const newMax = len + 10;
        addElements(newMin, newMax);

        // Move the sentinel to the end
        content.removeChild(sentinel); // remove from the current position
        content.appendChild(sentinel); // add to the end

        // Observe the new position of the sentinel
        observer.observe(sentinel);
      }

      function lookupTeamName(num, targetElement, min, max) {
        const teamNumber = num;

        // Make a GraphQL query to retrieve the team name based on the team number
        fetch('https://api.ftcscout.org/graphql', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
          },
          body: JSON.stringify({
            query: `
              {
                teamByNumber(number: ${teamNumber}) {
                  name
                }
              }
            `,
          }),
        })
        .then(response => response.json())
        .then(data => {
          const teamName = data.data.teamByNumber ? data.data.teamByNumber.name : 'Team not found';

          // Check if the team name is unique
          if (!uniqueTeamNames.has(teamName)) {
            uniqueTeamNames.add(teamName);

            // Display team name with team number
            targetElement.innerText = `Team Name: ${teamName} (Team Number: ${teamNumber})`;
          } else {
            // If not unique, try with the next team number
            // if (!triedNum.has(num){
            //   lookupTeamName(num + 1, targetElement, min, max);
            //   triedNum.add(num);
            // }
            while(uniqueTeamNames.has(teamName) || triedNum.has(num){
              if (triedNum.has(num)){
                num = num + 1;
              }
              lookupTeamName(num + 1, targetElement, min, max)
              if (uniqueTeamNames.has(teamName) {
                triedNum.add(num);
                num = num + 1;
              }
            }

            
            // } elseif (!triedNum.has(num + 2){
            //   lookupTeamName(num + 2, targetElement, min, max);
            //   triedNum.add(num + 2);
            // }elseif (!triedNum.has(num + 3){
            //   lookupTeamName(num + 3, targetElement, min, max);
            //   triedNum.add(num + 3);
            // }elseif (!triedNum.has(num + 4){
            //   lookupTeamName(num + 4, targetElement, min, max);
            //   triedNum.add(num + 4);
            // }elseif (!triedNum.has(num + 5){
            //   lookupTeamName(num + 5, targetElement, min, max);
            //   triedNum.add(num + 5);
            // }elseif (!triedNum.has(num + 6){
            //   lookupTeamName(num + 6, targetElement, min, max);
            //   triedNum.add(num + 6);
            // }elseif (!triedNum.has(num + 7){
            //   lookupTeamName(num + 7, targetElement, min, max);
            //   triedNum.add(num + 7);
            // }elseif (!triedNum.has(num + 8){
            //   lookupTeamName(num + 8, targetElement, min, max);
            //   triedNum.add(num + 8);
            // }elseif (!triedNum.has(num + 9){
            //   lookupTeamName(num + 9, targetElement, min, max);
            //   triedNum.add(num + 9);
            // }elseif (!triedNum.has(num + 10){
            //   lookupTeamName(num + 10, targetElement, min, max);
            //   triedNum.add(num + 10);
            // }elseif (!triedNum.has(num + 11){
            //   lookupTeamName(num + 11, targetElement, min, max);
            //   triedNum.add(num + 11);
            // }elseif (!triedNum.has(num + 12){
            //   lookupTeamName(num + 12, targetElement, min, max);
            //   triedNum.add(num + 12);
            // }elseif (!triedNum.has(num + 13){
            //   lookupTeamName(num + 13, targetElement, min, max);
            //   triedNum.add(num + 13);
            // }
          }
        })
        .catch(error => console.error('Error:', error));
      }

      const observer = new IntersectionObserver(handleIntersection, options);
      observer.observe(sentinel);
    </script>
  </body>
</html>
